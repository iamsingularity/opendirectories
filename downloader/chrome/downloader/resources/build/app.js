// Generated by CoffeeScript 1.9.3
(function() {
  var app, debug, icons;

  app = angular.module("downloader", ["ng-token-auth", "ngAria", "ngAnimate", "ngMaterial", "ngMdIcons", "downloader.auth", "downloader.downloads"]);

  icons = {
    initial: "cloud_circle",
    queued: "cloud",
    started: "cloud_download",
    finished: "done",
    error: "error",
    cancelled: "cloud_off"
  };

  debug = true;

  app.constant("SERVER", "localhost");

  app.constant("PORT", 3000);

  app.factory("Server", [
    "SERVER", "PORT", function(SERVER, PORT) {
      return {
        service: {
          toString: function() {
            return "http://" + SERVER + ":" + PORT;
          },
          build: function(path) {
            return "http://" + SERVER + ":" + PORT + path;
          }
        }
      };
    }
  ]);

  app.config(function($authProvider, SERVER, PORT) {
    return $authProvider.configure({
      apiUrl: "http://" + SERVER + ":" + PORT
    });
  });

  app.controller("appController", [
    "$scope", "$rootScope", "$mdMedia", "$http", "$mdDialog", "Server", "$auth", function($scope, $rootScope, $mdMedia, $http, $mdDialog, Server, $auth) {
      var deleteDownload, setUser;
      $scope.Server = Server;
      $scope.user = null;
      setUser = function(user) {
        var initials, split;
        $scope.user = user;
        initials = (function() {
          var i, len, ref, results;
          ref = $scope.user.email.split(/@/);
          results = [];
          for (i = 0, len = ref.length; i < len; i++) {
            split = ref[i];
            results.push(split[0].toUpperCase());
          }
          return results;
        })();
        return $scope.user.initials = initials.slice(0, 2).join("");
      };
      $auth.validateUser().then(function(data) {
        setUser(data);
        return $scope.getDownloads();
      }, function() {
        return $mdDialog.show({
          templateUrl: "log-in.html",
          controller: "authController",
          clickOutsideToClose: false
        });
      });
      $scope.logOut = function() {
        return $auth.signOut().then(function() {
          return $mdDialog.show({
            templateUrl: "log-in.html",
            controller: "authController",
            clickOutsideToClose: false
          });
        });
      };
      $rootScope.$on("auth:login-success", function(ev, user) {
        setUser(user);
        return $scope.getDownloads();
      });
      $rootScope.$on("auth:logout-success", function(ev) {
        $scope.user = null;
        return $scope.downloads = [];
      });
      $rootScope.$on("downloads.get", function() {
        return $scope.getDownloads();
      });
      $scope.getDownloads = function() {
        return $http({
          method: "GET",
          url: Server.service.build("/api/v1/downloads.json"),
          dataType: "jsonp"
        }).success(function(data) {
          var item;
          data.items = (function() {
            var i, len, ref, results;
            ref = data.items;
            results = [];
            for (i = 0, len = ref.length; i < len; i++) {
              item = ref[i];
              item = JSON.parse(item);
              item.visible = false;
              item.icon = icons[item.status];
              item.hasPointer = item.status !== "initial" && item.status !== "queued";
              item.canDelete = item.status !== "started" && item.status !== "queued";
              item.canCancel = item.status === "queued";
              item.canQueue = item.status === "initial" || item.status === "finished" || item.status === "error" || item.status === "cancelled";
              results.push(item);
            }
            return results;
          })();
          return $scope.downloads = data;
        });
      };
      $scope.newDownload = function($event) {
        return $mdDialog.show({
          templateUrl: "new-download.html",
          controller: "NewDownloadController",
          clickOutsideToClose: false
        }).then(function() {
          return $scope.getDownloads();
        });
      };
      $scope.deleteDownload = function(download, $event) {
        var confirm;
        confirm = $mdDialog.confirm().title("Delete Download").content("Are you sure you want to delete '" + download.url + "'?").ok("BE GONE WITH IT!").cancel("No").targetEvent($event);
        return $mdDialog.show(confirm).then((function() {
          return deleteDownload(download);
        }), function() {
          return $scope.getDownloads();
        });
      };
      deleteDownload = function(download) {
        if (!download.canDelete) {
          return;
        }
        return $http({
          method: "DELETE",
          url: Server.service.build("/api/v1/downloads/" + download.id),
          dataType: "jsonp"
        }).success(function() {
          return $scope.getDownloads();
        });
      };
      $scope.cancelDownload = function(download) {
        if (!download.canCancel) {
          return;
        }
        return $http({
          method: "PUT",
          url: Server.service.build("/api/v1/downloads/" + download.id + "/cancel"),
          dataType: "jsonp"
        }).success(function() {
          return $scope.getDownloads();
        });
      };
      return $scope.queueDownload = function(download) {
        if (!download.canQueue) {
          return;
        }
        return $http({
          method: "PUT",
          url: Server.service.build("/api/v1/downloads/" + download.id + "/queue"),
          dataType: "jsonp"
        }).success(function() {
          return $scope.getDownloads();
        });
      };
    }
  ]);

}).call(this);
